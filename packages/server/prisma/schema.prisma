generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───

enum OAuthProvider {
  GOOGLE
  APPLE
}

enum Locale {
  KO
  EN
}

enum Visibility {
  PRIVATE
  PUBLIC
}

enum CrawlStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MessageRole {
  USER
  ASSISTANT
}

enum Feedback {
  UP
  DOWN
}

enum IntegrationType {
  GITHUB
}

enum InterviewStatus {
  IN_PROGRESS
  COMPLETED
}

enum WorkspaceRole {
  ADMIN
  MEMBER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum NotificationType {
  SUBSCRIPTION_NEW_LINK
  CONTENT_UPDATED
  UNREAD_REMINDER
  UNUSED_LINKS
  WEAKNESS_DETECTED
  WORKSPACE_INVITE
  RSS_NEW_ITEMS
}

// ─── Models ───

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  nickname      String
  profileImage  String?
  locale        Locale    @default(KO)
  profilePublic Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  oauths            OAuth[]
  folders           Folder[]
  links             Link[]
  conversations     Conversation[]
  weeklyReviews     WeeklyReview[]
  integrations      Integration[]
  rssFeeds          RssFeed[]
  interviewSessions InterviewSession[]
  workspaceMembers  WorkspaceMember[]
  subscribedTo      Subscription[]     @relation("Subscriber")
  subscribers       Subscription[]     @relation("Target")
  notifications     Notification[]

  @@map("users")
}

model OAuth {
  id         Int           @id @default(autoincrement())
  userId     Int
  provider   OAuthProvider
  providerId String
  createdAt  DateTime      @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauths")
}

model Translation {
  id        Int      @id @default(autoincrement())
  key       String
  locale    Locale
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, locale])
  @@index([locale])
  @@map("translations")
}

model Folder {
  id         Int        @id @default(autoincrement())
  userId     Int
  parentId   Int?
  name       String
  isDocked   Boolean    @default(false)
  visibility Visibility @default(PRIVATE)
  shareToken String?    @unique
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   Folder?  @relation("FolderTree", fields: [parentId], references: [id], onDelete: SetNull)
  children Folder[] @relation("FolderTree")
  links    Link[]

  @@index([userId])
  @@index([parentId])
  @@map("folders")
}

model Link {
  id             Int         @id @default(autoincrement())
  userId         Int
  folderId       Int?
  url            String
  ogTitle        String?
  ogDescription  String?
  ogImage        String?
  summary        String?
  memo           String?
  crawlStatus    CrawlStatus @default(PENDING)
  visibility     Visibility  @default(PRIVATE)
  readAt         DateTime?
  contentUpdated Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  deletedAt      DateTime?

  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder     Folder?         @relation(fields: [folderId], references: [id], onDelete: SetNull)
  linkTags   LinkTag[]
  embeddings LinkEmbedding[]

  @@unique([userId, url])
  @@index([userId])
  @@index([folderId])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("links")
}

model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())

  linkTags LinkTag[]

  @@map("tags")
}

model LinkTag {
  id        Int      @id @default(autoincrement())
  linkId    Int
  tagId     Int
  createdAt DateTime @default(now())

  link Link @relation(fields: [linkId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([linkId, tagId])
  @@index([linkId])
  @@index([tagId])
  @@map("link_tags")
}

// ─── Phase 1: RAG ───

model LinkEmbedding {
  id         Int                          @id @default(autoincrement())
  linkId     Int
  chunkIndex Int
  chunkText  String
  embedding  Unsupported("vector(1536)")
  createdAt  DateTime                     @default(now())

  link Link @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@unique([linkId, chunkIndex])
  @@index([linkId])
  @@map("link_embeddings")
}

model Conversation {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@map("conversations")
}

model Message {
  id             Int         @id @default(autoincrement())
  conversationId Int
  role           MessageRole
  content        String
  sources        Json?
  feedback       Feedback?
  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

// ─── Phase 2: Learning Accelerator ───

model WeeklyReview {
  id             Int      @id @default(autoincrement())
  userId         Int
  week           String
  savedLinks     Int      @default(0)
  readLinks      Int      @default(0)
  questionsAsked Int      @default(0)
  topTopics      Json
  summary        String
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, week])
  @@index([userId])
  @@map("weekly_reviews")
}

// ─── Phase 3: Second Brain ───

model Integration {
  id               Int             @id @default(autoincrement())
  userId           Int
  type             IntegrationType
  accessToken      String
  refreshToken     String?
  externalUsername  String?
  connectedAt      DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
  @@map("integrations")
}

model RssFeed {
  id            Int       @id @default(autoincrement())
  userId        Int
  feedUrl       String
  title         String?
  lastFetchedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, feedUrl])
  @@index([userId])
  @@map("rss_feeds")
}

model InterviewSession {
  id        Int             @id @default(autoincrement())
  userId    Int
  topics    Json
  status    InterviewStatus @default(IN_PROGRESS)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions InterviewQuestion[]

  @@index([userId])
  @@map("interview_sessions")
}

model InterviewQuestion {
  id             Int      @id @default(autoincrement())
  sessionId      Int
  question       String
  relatedLinkIds Json
  answer         String?
  evaluation     String?
  gaps           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  session InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("interview_questions")
}

// ─── Phase 4: Developer Platform ───

model Workspace {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members WorkspaceMember[]
  invites WorkspaceInvite[]

  @@map("workspaces")
}

model WorkspaceMember {
  id          Int           @id @default(autoincrement())
  workspaceId Int
  userId      Int
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

model WorkspaceInvite {
  id          Int           @id @default(autoincrement())
  workspaceId Int
  email       String
  role        WorkspaceRole @default(MEMBER)
  token       String        @unique
  status      InviteStatus  @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("workspace_invites")
}

model Subscription {
  id           Int      @id @default(autoincrement())
  subscriberId Int
  targetId     Int
  createdAt    DateTime @default(now())

  subscriber User @relation("Subscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  target     User @relation("Target", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, targetId])
  @@index([subscriberId])
  @@index([targetId])
  @@map("subscriptions")
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      NotificationType
  message   String
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}
